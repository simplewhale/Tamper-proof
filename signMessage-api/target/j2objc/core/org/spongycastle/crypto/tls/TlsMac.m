//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/alen/Downloads/signMessage-api/target/classes/core/org/spongycastle/crypto/tls/TlsMac.java
//

#include "IOSPrimitiveArray.h"
#include "J2ObjC_source.h"
#include "java/lang/Math.h"
#include "org/spongycastle/crypto/Digest.h"
#include "org/spongycastle/crypto/Mac.h"
#include "org/spongycastle/crypto/digests/LongDigest.h"
#include "org/spongycastle/crypto/macs/HMac.h"
#include "org/spongycastle/crypto/params/KeyParameter.h"
#include "org/spongycastle/crypto/tls/ProtocolVersion.h"
#include "org/spongycastle/crypto/tls/SSL3Mac.h"
#include "org/spongycastle/crypto/tls/SecurityParameters.h"
#include "org/spongycastle/crypto/tls/TlsContext.h"
#include "org/spongycastle/crypto/tls/TlsMac.h"
#include "org/spongycastle/crypto/tls/TlsUtils.h"
#include "org/spongycastle/util/Arrays.h"

@implementation OrgSpongycastleCryptoTlsTlsMac

- (instancetype)initWithOrgSpongycastleCryptoTlsTlsContext:(id<OrgSpongycastleCryptoTlsTlsContext>)context
                           withOrgSpongycastleCryptoDigest:(id<OrgSpongycastleCryptoDigest>)digest
                                             withByteArray:(IOSByteArray *)key
                                                   withInt:(jint)keyOff
                                                   withInt:(jint)keyLen {
  OrgSpongycastleCryptoTlsTlsMac_initWithOrgSpongycastleCryptoTlsTlsContext_withOrgSpongycastleCryptoDigest_withByteArray_withInt_withInt_(self, context, digest, key, keyOff, keyLen);
  return self;
}

- (IOSByteArray *)getMACSecret {
  return self->secret_;
}

- (jint)getSize {
  return macLength_;
}

- (IOSByteArray *)calculateMacWithLong:(jlong)seqNo
                             withShort:(jshort)type
                         withByteArray:(IOSByteArray *)message
                               withInt:(jint)offset
                               withInt:(jint)length {
  OrgSpongycastleCryptoTlsProtocolVersion *serverVersion = [((id<OrgSpongycastleCryptoTlsTlsContext>) nil_chk(context_)) getServerVersion];
  jboolean isSSL = [((OrgSpongycastleCryptoTlsProtocolVersion *) nil_chk(serverVersion)) isSSL];
  IOSByteArray *macHeader = [IOSByteArray newArrayWithLength:isSSL ? 11 : 13];
  OrgSpongycastleCryptoTlsTlsUtils_writeUint64WithLong_withByteArray_withInt_(seqNo, macHeader, 0);
  OrgSpongycastleCryptoTlsTlsUtils_writeUint8WithShort_withByteArray_withInt_(type, macHeader, 8);
  if (!isSSL) {
    OrgSpongycastleCryptoTlsTlsUtils_writeVersionWithOrgSpongycastleCryptoTlsProtocolVersion_withByteArray_withInt_(serverVersion, macHeader, 9);
  }
  OrgSpongycastleCryptoTlsTlsUtils_writeUint16WithInt_withByteArray_withInt_(length, macHeader, macHeader->size_ - 2);
  [((id<OrgSpongycastleCryptoMac>) nil_chk(mac_)) updateWithByteArray:macHeader withInt:0 withInt:macHeader->size_];
  [((id<OrgSpongycastleCryptoMac>) nil_chk(mac_)) updateWithByteArray:message withInt:offset withInt:length];
  IOSByteArray *result = [IOSByteArray newArrayWithLength:[((id<OrgSpongycastleCryptoMac>) nil_chk(mac_)) getMacSize]];
  [((id<OrgSpongycastleCryptoMac>) nil_chk(mac_)) doFinalWithByteArray:result withInt:0];
  return [self truncateWithByteArray:result];
}

- (IOSByteArray *)calculateMacConstantTimeWithLong:(jlong)seqNo
                                         withShort:(jshort)type
                                     withByteArray:(IOSByteArray *)message
                                           withInt:(jint)offset
                                           withInt:(jint)length
                                           withInt:(jint)fullLength
                                     withByteArray:(IOSByteArray *)dummyData {
  IOSByteArray *result = [self calculateMacWithLong:seqNo withShort:type withByteArray:message withInt:offset withInt:length];
  jint headerLength = OrgSpongycastleCryptoTlsTlsUtils_isSSLWithOrgSpongycastleCryptoTlsTlsContext_(context_) ? 11 : 13;
  jint extra = [self getDigestBlockCountWithInt:headerLength + fullLength] - [self getDigestBlockCountWithInt:headerLength + length];
  while (--extra >= 0) {
    [((id<OrgSpongycastleCryptoMac>) nil_chk(mac_)) updateWithByteArray:dummyData withInt:0 withInt:digestBlockSize_];
  }
  [((id<OrgSpongycastleCryptoMac>) nil_chk(mac_)) updateWithByte:IOSByteArray_Get(nil_chk(dummyData), 0)];
  [((id<OrgSpongycastleCryptoMac>) nil_chk(mac_)) reset];
  return result;
}

- (jint)getDigestBlockCountWithInt:(jint)inputLength {
  return (inputLength + digestOverhead_) / digestBlockSize_;
}

- (IOSByteArray *)truncateWithByteArray:(IOSByteArray *)bs {
  if (((IOSByteArray *) nil_chk(bs))->size_ <= macLength_) {
    return bs;
  }
  return OrgSpongycastleUtilArrays_copyOfWithByteArray_withInt_(bs, macLength_);
}

+ (const J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { NULL, NULL, 0x1, -1, 0, -1, -1, -1, -1 },
    { NULL, "[B", 0x1, -1, -1, -1, -1, -1, -1 },
    { NULL, "I", 0x1, -1, -1, -1, -1, -1, -1 },
    { NULL, "[B", 0x1, 1, 2, -1, -1, -1, -1 },
    { NULL, "[B", 0x1, 3, 4, -1, -1, -1, -1 },
    { NULL, "I", 0x4, 5, 6, -1, -1, -1, -1 },
    { NULL, "[B", 0x4, 7, 8, -1, -1, -1, -1 },
  };
  #pragma clang diagnostic push
  #pragma clang diagnostic ignored "-Wobjc-multiple-method-names"
  #pragma clang diagnostic ignored "-Wundeclared-selector"
  methods[0].selector = @selector(initWithOrgSpongycastleCryptoTlsTlsContext:withOrgSpongycastleCryptoDigest:withByteArray:withInt:withInt:);
  methods[1].selector = @selector(getMACSecret);
  methods[2].selector = @selector(getSize);
  methods[3].selector = @selector(calculateMacWithLong:withShort:withByteArray:withInt:withInt:);
  methods[4].selector = @selector(calculateMacConstantTimeWithLong:withShort:withByteArray:withInt:withInt:withInt:withByteArray:);
  methods[5].selector = @selector(getDigestBlockCountWithInt:);
  methods[6].selector = @selector(truncateWithByteArray:);
  #pragma clang diagnostic pop
  static const J2ObjcFieldInfo fields[] = {
    { "context_", "LOrgSpongycastleCryptoTlsTlsContext;", .constantValue.asLong = 0, 0x4, -1, -1, -1, -1 },
    { "secret_", "[B", .constantValue.asLong = 0, 0x4, -1, -1, -1, -1 },
    { "mac_", "LOrgSpongycastleCryptoMac;", .constantValue.asLong = 0, 0x4, -1, -1, -1, -1 },
    { "digestBlockSize_", "I", .constantValue.asLong = 0, 0x4, -1, -1, -1, -1 },
    { "digestOverhead_", "I", .constantValue.asLong = 0, 0x4, -1, -1, -1, -1 },
    { "macLength_", "I", .constantValue.asLong = 0, 0x4, -1, -1, -1, -1 },
  };
  static const void *ptrTable[] = { "LOrgSpongycastleCryptoTlsTlsContext;LOrgSpongycastleCryptoDigest;[BII", "calculateMac", "JS[BII", "calculateMacConstantTime", "JS[BIII[B", "getDigestBlockCount", "I", "truncate", "[B" };
  static const J2ObjcClassInfo _OrgSpongycastleCryptoTlsTlsMac = { "TlsMac", "org.spongycastle.crypto.tls", ptrTable, methods, fields, 7, 0x1, 7, 6, -1, -1, -1, -1, -1 };
  return &_OrgSpongycastleCryptoTlsTlsMac;
}

@end

void OrgSpongycastleCryptoTlsTlsMac_initWithOrgSpongycastleCryptoTlsTlsContext_withOrgSpongycastleCryptoDigest_withByteArray_withInt_withInt_(OrgSpongycastleCryptoTlsTlsMac *self, id<OrgSpongycastleCryptoTlsTlsContext> context, id<OrgSpongycastleCryptoDigest> digest, IOSByteArray *key, jint keyOff, jint keyLen) {
  NSObject_init(self);
  self->context_ = context;
  OrgSpongycastleCryptoParamsKeyParameter *keyParameter = new_OrgSpongycastleCryptoParamsKeyParameter_initWithByteArray_withInt_withInt_(key, keyOff, keyLen);
  self->secret_ = OrgSpongycastleUtilArrays_cloneWithByteArray_([keyParameter getKey]);
  if ([digest isKindOfClass:[OrgSpongycastleCryptoDigestsLongDigest class]]) {
    self->digestBlockSize_ = 128;
    self->digestOverhead_ = 16;
  }
  else {
    self->digestBlockSize_ = 64;
    self->digestOverhead_ = 8;
  }
  if (OrgSpongycastleCryptoTlsTlsUtils_isSSLWithOrgSpongycastleCryptoTlsTlsContext_(context)) {
    self->mac_ = new_OrgSpongycastleCryptoTlsSSL3Mac_initWithOrgSpongycastleCryptoDigest_(digest);
    if ([((id<OrgSpongycastleCryptoDigest>) nil_chk(digest)) getDigestSize] == 20) {
      self->digestOverhead_ = 4;
    }
  }
  else {
    self->mac_ = new_OrgSpongycastleCryptoMacsHMac_initWithOrgSpongycastleCryptoDigest_(digest);
  }
  [((id<OrgSpongycastleCryptoMac>) nil_chk(self->mac_)) init__WithOrgSpongycastleCryptoCipherParameters:keyParameter];
  self->macLength_ = [((id<OrgSpongycastleCryptoMac>) nil_chk(self->mac_)) getMacSize];
  if (((OrgSpongycastleCryptoTlsSecurityParameters *) nil_chk([((id<OrgSpongycastleCryptoTlsTlsContext>) nil_chk(context)) getSecurityParameters]))->truncatedHMac_) {
    self->macLength_ = JavaLangMath_minWithInt_withInt_(self->macLength_, 10);
  }
}

OrgSpongycastleCryptoTlsTlsMac *new_OrgSpongycastleCryptoTlsTlsMac_initWithOrgSpongycastleCryptoTlsTlsContext_withOrgSpongycastleCryptoDigest_withByteArray_withInt_withInt_(id<OrgSpongycastleCryptoTlsTlsContext> context, id<OrgSpongycastleCryptoDigest> digest, IOSByteArray *key, jint keyOff, jint keyLen) {
  J2OBJC_NEW_IMPL(OrgSpongycastleCryptoTlsTlsMac, initWithOrgSpongycastleCryptoTlsTlsContext_withOrgSpongycastleCryptoDigest_withByteArray_withInt_withInt_, context, digest, key, keyOff, keyLen)
}

OrgSpongycastleCryptoTlsTlsMac *create_OrgSpongycastleCryptoTlsTlsMac_initWithOrgSpongycastleCryptoTlsTlsContext_withOrgSpongycastleCryptoDigest_withByteArray_withInt_withInt_(id<OrgSpongycastleCryptoTlsTlsContext> context, id<OrgSpongycastleCryptoDigest> digest, IOSByteArray *key, jint keyOff, jint keyLen) {
  J2OBJC_CREATE_IMPL(OrgSpongycastleCryptoTlsTlsMac, initWithOrgSpongycastleCryptoTlsTlsContext_withOrgSpongycastleCryptoDigest_withByteArray_withInt_withInt_, context, digest, key, keyOff, keyLen)
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(OrgSpongycastleCryptoTlsTlsMac)
